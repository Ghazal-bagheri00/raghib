import{r as o,a as Ve}from"./vendor-SIwY82C9.js";import{C as ze,P as Ye,a as Ue,W as Te,E as ye,S as Ze,b as Ke,X as $e,B as Qe,c as et,d as tt}from"./icons-BcL3sWas.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))u(d);new MutationObserver(d=>{for(const x of d)if(x.type==="childList")for(const S of x.addedNodes)S.tagName==="LINK"&&S.rel==="modulepreload"&&u(S)}).observe(document,{childList:!0,subtree:!0});function m(d){const x={};return d.integrity&&(x.integrity=d.integrity),d.referrerPolicy&&(x.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?x.credentials="include":d.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function u(d){if(d.ep)return;d.ep=!0;const x=m(d);fetch(d.href,x)}})();var De={exports:{}},we={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var st=o,rt=Symbol.for("react.element"),ot=Symbol.for("react.fragment"),nt=Object.prototype.hasOwnProperty,lt=st.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,at={key:!0,ref:!0,__self:!0,__source:!0};function Be(i,r,m){var u,d={},x=null,S=null;m!==void 0&&(x=""+m),r.key!==void 0&&(x=""+r.key),r.ref!==void 0&&(S=r.ref);for(u in r)nt.call(r,u)&&!at.hasOwnProperty(u)&&(d[u]=r[u]);if(i&&i.defaultProps)for(u in r=i.defaultProps,r)d[u]===void 0&&(d[u]=r[u]);return{$$typeof:rt,type:i,key:x,ref:S,props:d,_owner:lt.current}}we.Fragment=ot;we.jsx=Be;we.jsxs=Be;De.exports=we;var e=De.exports,Fe,Re=Ve;Fe=Re.createRoot,Re.hydrateRoot;const xe=o.createContext(null),H=i=>`${Math.round(i/10).toLocaleString()} تومان`,oe=()=>e.jsx("div",{className:"flex justify-center items-center py-4",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"})}),it=({isLoading:i})=>i?e.jsx("div",{className:"fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-30",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-8 flex flex-col items-center gap-4 border border-gray-200",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-emerald-500 border-t-transparent"}),e.jsx("p",{className:"text-gray-700 font-medium",children:"در حال بارگذاری..."})]})}):null,Ee=({title:i,onBack:r,compact:m=!1})=>e.jsxs("header",{className:`sticky top-0 bg-white shadow-sm ${m?"p-2":"p-4"} flex items-center justify-between z-40 rounded-b-xl`,children:[r&&e.jsx("button",{onClick:r,className:"text-gray-600 hover:text-emerald-600 transition-colors duration-200",children:e.jsx(Ue,{size:24})}),e.jsx("h1",{className:"text-lg font-bold text-gray-800 mx-auto",children:i}),e.jsx("div",{className:"w-6"})]}),ct=({product:i,onClick:r,onBasalamPageClick:m})=>e.jsxs("div",{className:"bg-white rounded-xl shadow-md overflow-hidden cursor-pointer flex flex-col transition-all duration-300 ease-in-out hover:shadow-lg hover:border-emerald-500 border border-gray-200",children:[e.jsx("div",{className:"relative w-full h-40 overflow-hidden",onClick:r,children:e.jsx("img",{src:i.photo_id,alt:i.title,className:"w-full h-full object-cover transition-transform duration-300 ease-in-out hover:scale-105",onError:u=>{u.target.onerror=null,u.target.src="https://placehold.co/200x200/cccccc/333333?text=No+Image"}})}),e.jsxs("div",{className:"p-3 flex-grow flex flex-col",onClick:r,children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-800 mb-1 leading-tight line-clamp-2",children:i.title}),e.jsx("p",{className:"text-emerald-600 font-bold text-base mt-auto",children:H(i.price)})]}),e.jsx("div",{className:"p-3 border-t border-gray-100",children:e.jsxs("button",{onClick:m,className:"w-full flex items-center justify-center py-2 px-3 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out shadow-sm",children:[e.jsx(ye,{size:16,className:"ml-2"}),"مشاهده در Basalam"]})})]}),dt=()=>{const{navigate:i,setSelectedProduct:r,authorizedFetch:m,basalamToken:u,setGlobalLoading:d}=o.useContext(xe),[x,S]=o.useState(""),[_,$]=o.useState(6),w=o.useRef(null),[R,M]=o.useState(!1),[k,L]=o.useState(null),[v,C]=o.useState([]),h=s=>{var Q,J,ge,U,D,ce,ee,de,W,te,se,ue,me,be,pe;const I=String((s==null?void 0:s.id)??""),A=String((s==null?void 0:s.name)??""),P=Number((s==null?void 0:s.price)??0),z=((Q=s==null?void 0:s.photo)==null?void 0:Q.MEDIUM)||((J=s==null?void 0:s.photo)==null?void 0:J.SMALL)||((ge=s==null?void 0:s.photo)==null?void 0:ge.LARGE)||((U=s==null?void 0:s.photo)==null?void 0:U.EXTRA_SMALL)||(s==null?void 0:s.photo)||((D=s==null?void 0:s.photos)==null?void 0:D.MEDIUM)||((ce=s==null?void 0:s.photos)==null?void 0:ce.SMALL)||((ee=s==null?void 0:s.photos)==null?void 0:ee.LARGE)||"https://placehold.co/200x200/cccccc/333333?text=No+Image",y=[];z&&y.push(z),(de=s==null?void 0:s.photo)!=null&&de.LARGE&&!y.includes(s.photo.LARGE)&&y.push(s.photo.LARGE),(W=s==null?void 0:s.photo)!=null&&W.MEDIUM&&!y.includes(s.photo.MEDIUM)&&y.push(s.photo.MEDIUM),(te=s==null?void 0:s.photo)!=null&&te.SMALL&&!y.includes(s.photo.SMALL)&&y.push(s.photo.SMALL),(se=s==null?void 0:s.photos)!=null&&se.MEDIUM&&!y.includes(s.photos.MEDIUM)&&y.push(s.photos.MEDIUM),(ue=s==null?void 0:s.photos)!=null&&ue.SMALL&&!y.includes(s.photos.SMALL)&&y.push(s.photos.SMALL);const ve=`https://basalam.com/${((me=s==null?void 0:s.vendor)==null?void 0:me.identifier)||"shop"}/product/${I}`,ae=(be=s==null?void 0:s.rating)==null?void 0:be.average,ie=(pe=s==null?void 0:s.rating)==null?void 0:pe.count,T=s==null?void 0:s.categoryTitle,K=[];T&&K.push(String(T)),ae!=null&&ie!=null&&K.push(`امتیاز ${ae} (${ie})`);const Ne=K.join(" • ")||"بدون توضیحات";return{id:I,title:A,price:P,photo_id:z,photos:y,description:Ne,basalamUrl:ve,createdAt:new Date().toISOString()}},ne=o.useRef(!1);o.useEffect(()=>{let s=!1;return(async()=>{if(u&&!ne.current){ne.current=!0,M(!0),d(!0),L(null);try{const A=await m("https://n8nstudent.dotavvab.com/webhook/my-products");let P=null;try{P=await A.json()}catch{}if(!A.ok){const y=P&&(P.message||P.error)||"خطا در دریافت محصولات";throw new Error(y)}const z=Array.isArray(P==null?void 0:P.products)?P.products.map(h):[];s||C(z)}catch(A){s||L((A==null?void 0:A.message)||"خطای نامشخص")}finally{s||(M(!1),d(!1))}}})(),()=>{s=!0}},[m,u,d]);const E=v.filter(s=>s.title.toLowerCase().includes(x.toLowerCase())),q=E.slice(0,_),he=o.useCallback(()=>{setTimeout(()=>{$(s=>Math.min(s+6,E.length))},300)},[E.length]);o.useEffect(()=>{const s=new IntersectionObserver(I=>{I[0].isIntersecting&&_<E.length&&he()},{threshold:.1});return w.current&&s.observe(w.current),()=>{w.current&&s.unobserve(w.current)}},[_,E.length,he]);const fe=s=>{r(s),i("product-detail")},le=(s,I)=>{s.stopPropagation(),window.open(I,"_blank")};return e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Ee,{title:"محصولات من",onBack:()=>i("dashboard")}),e.jsxs("div",{className:"p-4 flex flex-col space-y-4",children:[R&&e.jsx(oe,{}),k&&e.jsx("div",{className:"text-red-600 text-sm text-right",children:k}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"جستجوی محصول...",className:"w-full p-3 pl-10 pr-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm",value:x,onChange:s=>S(s.target.value)}),e.jsx(et,{size:20,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-16",children:[q.map(s=>e.jsx(ct,{product:s,onClick:()=>fe(s),onBasalamPageClick:I=>le(I,s.basalamUrl)},s.id)),_<E.length&&e.jsx("div",{ref:w,className:"col-span-full",children:e.jsx(oe,{})})]}),q.length===0&&e.jsx("p",{className:"text-center text-gray-500 mt-8",children:"محصولی یافت نشد."})]})]})},ut=()=>{const{navigate:i,selectedProduct:r,authorizedFetch:m,basalamToken:u,setGlobalLoading:d}=o.useContext(xe),[x,S]=o.useState(!1),[_,$]=o.useState(!1),[w,R]=o.useState(!1),[M,k]=o.useState(!1),[L,v]=o.useState(0),[C,h]=o.useState(null),[ne,E]=o.useState(!1),[q,he]=o.useState(""),[fe,le]=o.useState(null),[s,I]=o.useState(!1),[A,P]=o.useState(L),[z,y]=o.useState(!1),[Ie,ve]=o.useState(12),ae=o.useRef(null),ie=o.useRef(null),T=o.useRef(null),[K,Ne]=o.useState(!0),[Q,J]=o.useState(new Set),[ge,U]=o.useState(!1),[D,ce]=o.useState([]),[ee,de]=o.useState(!1),[W,te]=o.useState(null),se=o.useRef(new Map),[ue,me]=o.useState(new Set),[be,pe]=o.useState(0),[He,Se]=o.useState(!1);o.useEffect(()=>{if(!r)return;const t=localStorage.getItem(`hiddenIds_${r.id}`);if(t)try{const l=JSON.parse(t);J(new Set(l))}catch{}else J(new Set)},[r]),o.useEffect(()=>{r&&localStorage.setItem(`hiddenIds_${r.id}`,JSON.stringify(Array.from(Q)))},[Q,r]),o.useEffect(()=>{r||i("my-products")},[r,i]);const[qe,Ce]=o.useState([]),[Je,_e]=o.useState(!1),[Le,Ae]=o.useState(null),We=t=>{var F,G,V,Y,j,O,Z;const l=String((t==null?void 0:t.id)??""),a=String((t==null?void 0:t.name)??""),c=Number((t==null?void 0:t.price)??0),b=((F=t==null?void 0:t.photo)==null?void 0:F.MEDIUM)||((G=t==null?void 0:t.photo)==null?void 0:G.SMALL)||((V=t==null?void 0:t.photo)==null?void 0:V.LARGE)||((Y=t==null?void 0:t.photo)==null?void 0:Y.EXTRA_SMALL)||"https://placehold.co/200x200/cccccc/333333?text=No+Image",n=((j=t==null?void 0:t.vendor)==null?void 0:j.identifier)||"shop",g=`https://basalam.com/${n}/product/${l}`,p=(O=t==null?void 0:t.rating)==null?void 0:O.average,N=(Z=t==null?void 0:t.rating)==null?void 0:Z.count,f=t==null?void 0:t.categoryTitle,B=[];f&&B.push(String(f)),p!=null&&N!=null&&B.push(`امتیاز ${p} (${N})`);const X=B.join(" • ")||"بدون توضیحات";return{id:l,title:a,price:c,photo_id:b,description:X,basalamUrl:g,vendorIdentifier:n,isCompetitor:!1,createdAt:new Date().toISOString()}};o.useEffect(()=>{if(!r||!u||!r.title||!r.id){Ce([]);return}let t=!1;const a=setTimeout(async()=>{_e(!0),d(!0),Ae(null);try{const c=encodeURIComponent(r.title.trim()),b=encodeURIComponent(String(r.id)),n=`https://n8nstudent.dotavvab.com/webhook/mlt-search?title=${c}&product_id=${b}&page=1`,g=await m(n);let p=null;try{p=await g.json()}catch{}if(!g.ok){const f=p&&(p.message||p.error)||"خطا در جستجوی محصولات مشابه";throw new Error(f)}const N=Array.isArray(p==null?void 0:p.products)?p.products.map(We).filter(f=>f.id&&f.title):[];t||Ce(N)}catch(c){t||Ae((c==null?void 0:c.message)||"خطای نامشخص در جستجو")}finally{t||(_e(!1),d(!1))}},300);return()=>{t=!0,clearTimeout(a)}},[r,u,m,d]),o.useEffect(()=>{const t=r!=null&&r.id?String(r.id):"",l=/^\d+$/.test(t);if(!u||!r||!l){ce([]),te(null);return}let a=!1;const c=n=>{var X,F,G,V,Y,j,O,Z,re;const g=Number((n==null?void 0:n.id)??((X=n==null?void 0:n.product)==null?void 0:X.id))||0,p=((n==null?void 0:n.title)??((F=n==null?void 0:n.product)==null?void 0:F.title))||"",N=Number((n==null?void 0:n.price)??((V=(G=n==null?void 0:n.variants)==null?void 0:G[0])==null?void 0:V.price)??((Y=n==null?void 0:n.product)==null?void 0:Y.price)??((Z=(O=(j=n==null?void 0:n.product)==null?void 0:j.variants)==null?void 0:O[0])==null?void 0:Z.price)??0)||0,f=(n==null?void 0:n.photo)||((re=n==null?void 0:n.product)==null?void 0:re.photo)||null,B=typeof f=="string"?f:(f==null?void 0:f.md)||(f==null?void 0:f.original)||(f==null?void 0:f.sm)||(f==null?void 0:f.xs)||"";return{id:g,title:p,price:N,photo:B,vendorIdentifier:"",productUrl:""}};return(async()=>{var n;de(!0),te(null);try{const g=`https://n8nstudent.dotavvab.com/webhook/competitors?product_id=${t}`,p=await m(g),N=await p.json().catch(()=>({}));if(!p.ok)throw new Error(N&&(N.message||N.error)||"خطا در دریافت رقبا");const f=Array.isArray(N)?((n=N[0])==null?void 0:n.competitors)||[]:(N==null?void 0:N.competitors)||[],B=(Array.isArray(f)?f:[]).filter(j=>j&&j.op_product).map(j=>({op_product:Number(j.op_product),op_vendor:String(j.op_vendor||"")})),X=[],F=B.filter(j=>!se.current.has(j.op_product));let G=0;const V=3,Y=async()=>{for(;G<F.length&&!a;){const j=F[G++];try{const Z=await(await fetch(`https://n8nstudent.dotavvab.com/webhook/product?id=${j.op_product}`)).json().catch(()=>({})),re=c(Z);re.vendorIdentifier=j.op_vendor,re.productUrl=`https://basalam.com/${encodeURIComponent(j.op_vendor)}/product/${encodeURIComponent(j.op_product)}`,se.current.set(j.op_product,re)}catch{}}};await Promise.all(new Array(V).fill(0).map(Y));for(const j of B){const O=se.current.get(j.op_product);O&&X.push(O)}a||ce(X)}catch(g){a||te((g==null?void 0:g.message)||"خطای نامشخص")}finally{a||de(!1)}})(),()=>{a=!0}},[m,u,r,be]);const ke=o.useCallback(()=>{const t=window.scrollY;S(t>200)},[]);o.useEffect(()=>(window.addEventListener("scroll",ke),()=>window.removeEventListener("scroll",ke)),[ke]),o.useEffect(()=>{if(!w)return;const t=ie.current;if(!t)return;const l=new IntersectionObserver(a=>{a[0].isIntersecting&&ve(c=>c+8)},{root:null,threshold:.1});return l.observe(t),()=>l.disconnect()},[w]);const Xe=async t=>{if(!(r!=null&&r.id)||!(t!=null&&t.id)||!(t!=null&&t.vendorIdentifier)){h({message:"اطلاعات محصول ناقص است",type:"error"}),setTimeout(()=>h(null),2e3);return}const l=t.id;if(!ue.has(l))try{me(n=>new Set([...n,l]));const a={self_product:Number(r.id),op_product:Number(t.id),op_vendor:t.vendorIdentifier},c=await m("https://n8nstudent.dotavvab.com/webhook/competitors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});let b=null;try{b=await c.json()}catch{}if(!c.ok){const n=b&&(b.message||b.error)||"خطا در افزودن رقیب";throw new Error(n)}Ce(n=>n.map(g=>g.id===t.id?{...g,isCompetitor:!0}:g)),h({message:`"${t.title}" به عنوان رقیب اضافه شد`,type:"success"}),setTimeout(()=>h(null),3e3),setTimeout(()=>{pe(n=>n+1)},1e3)}catch(a){h({message:(a==null?void 0:a.message)||"خطا در افزودن رقیب",type:"error"}),setTimeout(()=>h(null),3e3)}finally{me(a=>{const c=new Set(a);return c.delete(l),c})}},Pe=qe.filter(t=>{if(!M||!r)return!0;const l=r.price*(1+L/100);return t.price<=l}).filter(t=>K?!Q.has(t.id):!0).sort((t,l)=>t.price!==l.price?t.price-l.price:t.isCompetitor===l.isCompetitor?0:t.isCompetitor?1:-1),Me=(t,l)=>a=>{l&&l(a),T.current&&(window.clearTimeout(T.current),T.current=null),T.current=window.setTimeout(()=>{le(t),T.current=null},450)},je=()=>{T.current&&(window.clearTimeout(T.current),T.current=null)};return r?e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Ee,{title:"جزئیات محصول",compact:!0}),e.jsx("button",{onClick:()=>i("my-products"),className:"fixed top-2 left-2 z-40 bg-white/90 border border-gray-200 p-2 rounded-full shadow hover:bg-white","aria-label":"بازگشت",children:e.jsx(Ue,{size:20,className:"text-gray-700"})}),x&&e.jsxs("div",{className:"fixed top-14 left-4 right-4 md:left-8 md:right-8 z-30 bg-white shadow-lg border border-gray-200 p-3 rounded-xl",onClick:()=>$(t=>!t),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:r.photo_id,alt:r.title,className:"w-16 h-16 object-cover rounded-md"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-800 text-sm md:text-base line-clamp-1",children:r.title}),e.jsx("p",{className:"text-emerald-600 font-bold text-sm md:text-md",children:H(r.price)})]})]}),e.jsx("span",{className:"text-blue-600 text-xs select-none",children:_?"نمایش کمتر":"مشاهده کامل"})]}),_&&e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm",children:[e.jsx("div",{className:"col-span-2",children:e.jsx("p",{className:"text-gray-700",children:r.description})}),e.jsx("div",{className:"flex gap-2 overflow-x-auto scrollbar-hide",children:r.photos.map((t,l)=>e.jsx("img",{src:t,alt:String(l),className:"w-24 h-20 object-cover rounded-md border cursor-zoom-in",onClick:a=>{a.stopPropagation(),le(t)}},l))})]})]}),e.jsxs("div",{className:"p-4 pt-0 md:p-6 pb-24 relative",children:[C&&e.jsx("div",{className:`fixed top-4 right-4 z-40 px-4 py-2 rounded-md shadow-md border ${C.type==="success"?"bg-green-50 border-green-200 text-green-700":C.type==="error"?"bg-red-50 border-red-200 text-red-700":"bg-blue-50 border-blue-200 text-blue-700"}`,children:C.message}),e.jsx("div",{className:"flex flex-nowrap overflow-x-auto gap-2 p-2 bg-white rounded-xl shadow-md mb-4 scrollbar-hide",children:r.photos.map((t,l)=>e.jsx("img",{src:t,alt:`${r.title} image ${l+1}`,className:"flex-shrink-0 w-40 h-32 object-cover rounded-lg shadow-sm border border-gray-100 cursor-zoom-in select-none",onPointerDown:Me(t),onPointerUp:je,onPointerLeave:je,onError:a=>{a.target.onerror=null,a.target.src="https://placehold.co/150x100/cccccc/333333?text=No+Image"}},l))}),fe&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/80 flex items-center justify-center",onClick:()=>le(null),children:e.jsx("img",{src:fe,alt:"full",className:"max-w-[95vw] max-h-[95vh] object-contain"})}),e.jsxs("div",{className:"bg-white p-4 rounded-xl shadow-md mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:r.title}),e.jsx("p",{className:"text-emerald-600 text-2xl font-bold mb-3",children:H(r.price)}),e.jsx("p",{className:"text-gray-700 text-sm leading-relaxed mb-4",children:r.description}),e.jsxs("div",{className:"border-t border-gray-200 pt-3 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-bold text-gray-800 text-md",children:"رقبای فعلی شما"}),e.jsx("span",{className:"text-sm text-gray-500",children:ee?"در حال بارگذاری...":`${D.length} رقیب`})]}),ee?e.jsx(oe,{}):W?e.jsx("p",{className:"text-red-600 text-sm",children:W}):D.length>0?e.jsxs(e.Fragment,{children:[(()=>{const t=D.filter(g=>typeof g.price=="number"&&g.price>0),l=t.length>0?t.reduce((g,p)=>p.price<g.price?p:g,t[0]):null,a=t.length>0?Math.round(t.reduce((g,p)=>g+p.price,0)/t.length):0,c=l?r.price-l.price:0,b=l?r.price<l.price:!1,n=l?Math.round(b?Math.abs(c)/r.price*100:Math.abs(c)/l.price*100):0;return e.jsxs("div",{className:"mb-3 space-y-1",children:[l&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-semibold text-gray-800",children:"کمترین قیمت رقیب:"}),e.jsx("a",{href:l.productUrl||`https://basalam.com/product/${l.id}`,target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline font-semibold",children:H(l.price)}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs border ${b?"bg-green-50 text-green-700 border-green-200":c===0?"bg-blue-50 text-blue-700 border-blue-200":"bg-red-50 text-red-700 border-red-200"}`,children:c===0?"=":b?`−${n}% ارزان‌تر`:`+${n}% گران‌تر`}),e.jsxs("span",{className:"text-gray-600 ml-1",children:["(شما: ",H(r.price),")"]})]}),a>0&&e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsx("span",{className:"font-semibold",children:"میانگین قیمت رقبا:"})," ",H(a)]})]})})(),e.jsx("div",{className:"mt-4 mb-3",children:e.jsxs("button",{onClick:()=>window.open(`https://vendor.basalam.com/edit-product/${r.id}`,"_blank"),className:"w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 ease-in-out shadow-sm flex items-center justify-center gap-2",children:[e.jsx(Te,{size:18}),"ویرایش محصول"]})}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"مشاهده جزئیات رقبا:"}),e.jsxs("button",{onClick:()=>Se(!0),className:"py-2 px-4 bg-orange-500 text-white font-medium rounded-lg hover:bg-orange-600 transition duration-200 ease-in-out shadow-sm flex items-center gap-2",children:[e.jsx(ye,{size:16}),"مشاهده کامل"]})]})]}):e.jsx("p",{className:"text-gray-500 text-sm",children:"هنوز رقیبی اضافه نشده است."})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3 mb-6",children:[e.jsxs("button",{onClick:()=>R(t=>!t),className:"flex-1 flex items-center justify-center p-4 bg-emerald-600 text-white rounded-xl shadow-md hover:bg-emerald-700 transition duration-300 ease-in-out",children:[e.jsx(Ze,{className:"ml-3"}),e.jsx("span",{className:"text-lg font-semibold",children:w?"پنهان کردن نتایج":"جست و جوی هوشمند"})]}),e.jsx("div",{})]}),w&&e.jsx(e.Fragment,{children:e.jsxs("div",{ref:ae,className:"bg-white p-4 rounded-xl shadow-md mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800 mb-3",children:"محصولات مشابه (از جستجوی زنده Basalam)"}),Je?e.jsx(oe,{}):Le?e.jsx("p",{className:"text-red-600 text-sm text-center py-4",children:Le}):Pe.length>0?e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[Pe.slice(0,Ie).map((t,l)=>{const a=ue.has(t.id),c=t.isCompetitor;return e.jsxs("div",{onClick:()=>!a&&!c&&Xe(t),"data-similar-id":t.id,className:`relative bg-gray-100 rounded-xl overflow-hidden flex flex-col items-center justify-between p-3 transition-all duration-300 ease-in-out ${a?"cursor-wait opacity-70":c?"cursor-default":"cursor-pointer"} border ${c?"border-2 border-green-500 shadow-[0_0_0_2px_rgba(34,197,94,0.2),0_10px_25px_-5px_rgba(34,197,94,0.5)]":a?"border-2 border-blue-500 shadow-[0_0_0_2px_rgba(59,130,246,0.2),0_10px_25px_-5px_rgba(59,130,246,0.5)]":"border-gray-200 hover:shadow-md hover:scale-[1.02]"}`,children:[e.jsx("img",{src:t.photo_id,alt:t.title,className:"w-28 h-28 object-cover rounded-lg mb-2 border border-gray-200 cursor-zoom-in select-none",onPointerDown:Me(t.photo_id,b=>b.stopPropagation()),onPointerUp:je,onPointerLeave:je,onError:b=>{b.target.onerror=null,b.target.src="https://placehold.co/120x120/cccccc/333333?text=Sim+Image"}}),e.jsx("button",{className:"absolute top-2 left-2 p-1 rounded-full bg-white/90 border hover:bg-white",onClick:b=>{b.stopPropagation(),window.open(t.basalamUrl,"_blank")},title:"مشاهده در باسلام",children:e.jsx(Ke,{size:14})}),e.jsx("h4",{className:"text-center text-sm font-semibold text-gray-800 mb-1 line-clamp-2",children:t.title}),e.jsx("p",{className:"text-emerald-600 font-bold text-base",children:H(t.price)}),a&&e.jsx("div",{className:"absolute inset-0 bg-white/80 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"}),e.jsx("span",{className:"text-xs text-blue-600 font-medium",children:"در حال افزودن..."})]})}),c&&e.jsx("div",{className:"absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium",children:"✓ اضافه شد"})]},t.id)}),e.jsx("div",{ref:ie,className:"col-span-full h-1"})]}):e.jsx("p",{className:"text-gray-500 text-center py-4",children:"هیچ محصول مشابهی یافت نشد."})]})}),e.jsx("div",{className:"fixed bottom-4 left-4 z-40",children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>y(t=>!t),className:"p-3 rounded-full border shadow-lg bg-white hover:bg-gray-50",title:"ابزارها",children:z?e.jsx($e,{size:18}):e.jsx(Te,{size:18})}),z&&e.jsxs("div",{className:"absolute bottom-12 left-0 bg-white border rounded-xl shadow-xl p-2 flex items-center gap-2",children:[e.jsx("button",{onClick:()=>U(!0),className:"p-2 rounded-full border hover:bg-gray-50",title:"چشم",children:e.jsx(ye,{size:16})}),e.jsx("button",{onClick:()=>Ne(t=>!t),className:`p-2 rounded-full border ${K?"bg-emerald-100 text-emerald-700":"bg-white"}`,title:"نمایش موارد جدید",children:e.jsx(Qe,{size:16})})]})]})}),ge&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/30 flex items-center justify-center p-4",onClick:()=>U(!1),children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl border border-gray-200 w-full max-w-sm",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h3",{className:"font-bold text-gray-800",children:"چشم (موارد پنهان)"})}),e.jsxs("div",{className:"p-4 space-y-3 text-sm",children:[e.jsx("p",{children:"چه کاری می‌خواهید انجام دهید؟"}),e.jsx("button",{className:"w-full px-3 py-2 rounded-md border hover:bg-gray-50",onClick:()=>{const t=Array.from((ae.current||document.createElement("div")).querySelectorAll("[data-similar-id]"));let l=-1;for(let a=0;a<t.length&&t[a].getBoundingClientRect().top<window.innerHeight-80;a++)l=a;if(l>=0){const a=[];for(let c=0;c<=l;c++){const b=t[c].dataset.similarId;b&&a.push(b)}J(c=>new Set([...Array.from(c),...a])),h({message:`${a.length} مورد اضافه شد`,type:"info"}),setTimeout(()=>h(null),1500)}U(!1)},children:"بروزرسانی چشم (اضافه کردن موارد دیده‌شده)"}),e.jsx("button",{className:"w-full px-3 py-2 rounded-md border hover:bg-red-50 text-red-700 border-red-200",onClick:()=>{confirm("لیست پنهان‌سازی ریست شود؟")&&(J(new Set),U(!1),h({message:"ریست شد",type:"info"}),setTimeout(()=>h(null),1500))},children:"ریست چشم"})]}),e.jsx("div",{className:"p-4 border-t text-right",children:e.jsx("button",{className:"px-3 py-2 text-sm rounded-md border",onClick:()=>U(!1),children:"بستن"})})]})}),s&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/30 flex items-center justify-center p-4",onClick:()=>I(!1),children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl border border-gray-200 w-full max-w-sm",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h3",{className:"font-bold text-gray-800",children:"فیلتر قیمت"})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"حداکثر درصد بالاتر از قیمت شما که نمایش داده شود:"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"range",min:0,max:50,step:1,value:A,onChange:t=>P(Number(t.target.value))}),e.jsxs("span",{className:"w-10 text-right",children:[A,"%"]})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["حالت فعال: ",M?`ارزان‌تر از ${L}% +`:"غیرفعال"]})]}),e.jsxs("div",{className:"p-4 border-t flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:M&&e.jsxs("div",{className:"flex items-center gap-2 text-xs bg-red-50 border border-red-200 text-red-700 px-2 py-1 rounded",children:[e.jsxs("span",{children:["Cheaper than ",L,"% +"]}),e.jsx("button",{className:"hover:underline",onClick:()=>{k(!1),v(0)},children:"×"})]})}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{className:"px-3 py-2 text-sm rounded-md border",onClick:()=>I(!1),children:"انصراف"}),e.jsx("button",{className:"px-3 py-2 text-sm rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:()=>{v(A),k(!0),I(!1)},children:"اعمال"})]})]})]})}),ne&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/30 flex items-center justify-center p-4",onClick:()=>E(!1),children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl border border-gray-200 w-full max-w-sm",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h3",{className:"font-bold text-gray-800",children:"تغییر قیمت"})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"قیمت جدید (تومان)"}),e.jsx("input",{type:"number",className:"w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500",value:q,onChange:t=>he(t.target.value),min:0}),e.jsx("p",{className:"text-xs text-gray-500",children:"برای اعمال قیمت جدید روی دکمه تایید کلیک کنید."})]}),e.jsxs("div",{className:"p-4 border-t flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 text-sm rounded-md border",onClick:()=>E(!1),children:"انصراف"}),e.jsx("button",{className:"px-3 py-2 text-sm rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:()=>{const t=Number(q);!isNaN(t)&&t>0&&(h({message:"قیمت با موفقیت به‌روزرسانی شد",type:"success"}),setTimeout(()=>h(null),2e3),E(!1))},children:"تایید"})]})]})}),He&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/30 flex items-center justify-center p-4",onClick:()=>Se(!1),children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl border border-gray-200 w-full max-w-4xl max-h-[90vh] overflow-hidden",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b bg-orange-500 text-white flex items-center justify-between",children:[e.jsx("h3",{className:"font-bold text-lg",children:"رقبای فعلی شما"}),e.jsx("button",{onClick:()=>Se(!1),className:"text-white hover:text-gray-200",children:e.jsx($e,{size:24})})]}),e.jsx("div",{className:"p-4 overflow-y-auto max-h-[calc(90vh-120px)]",children:ee?e.jsx(oe,{}):W?e.jsx("p",{className:"text-red-600 text-sm text-center py-4",children:W}):D.length>0?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:D.map(t=>{const l=typeof t.price=="number"&&t.price>0&&t.price<r.price,a=t.price===r.price;return e.jsxs("div",{className:`bg-gray-50 rounded-lg border p-3 flex flex-col items-center text-center ${l?"border-green-300":!a&&t.price?"border-red-200":""}`,children:[e.jsx("img",{src:t.photo||"https://placehold.co/120x120/cccccc/333333?text=Comp",alt:t.title,className:"w-24 h-24 object-cover rounded-md border mb-2",onError:c=>{c.target.onerror=null,c.target.src="https://placehold.co/120x120/cccccc/333333?text=Comp"}}),e.jsx("p",{className:"text-sm font-semibold text-gray-800 line-clamp-2 mb-2",children:t.title||`محصول ${t.id}`}),t.price?e.jsx("p",{className:`font-bold mb-2 ${l?"text-green-600":a?"text-blue-600":"text-red-600"}`,children:H(t.price)}):null,e.jsx("button",{className:"w-full py-2 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200",onClick:()=>window.open(t.productUrl||`https://basalam.com/product/${t.id}`,"_blank"),children:"مشاهده در باسلام"})]},t.id)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"هنوز رقیبی اضافه نشده است."}),e.jsx("p",{className:"text-sm text-gray-400",children:'برای افزودن رقیب، از بخش "جست و جوی هوشمند" استفاده کنید.'})]})})]})})]})]}):e.jsx(oe,{})},mt=()=>{const[i,r]=o.useState(()=>localStorage.getItem("authToken")||""),[m,u]=o.useState(()=>localStorage.getItem("authToken")?"dashboard":"login"),[d,x]=o.useState(null),[S,_]=o.useState(!1);o.useEffect(()=>{i?localStorage.setItem("authToken",i):localStorage.removeItem("authToken")},[i]);const $=o.useCallback(k=>{u(k),k==="my-products"&&x(null)},[]);o.useEffect(()=>{!i&&m!=="login"&&u("login")},[i,m]),o.useEffect(()=>{i&&m==="login"&&u("dashboard")},[i,m]);const w=()=>{switch(m){case"login":return e.jsx(xt,{});case"dashboard":return e.jsx(Oe,{});case"my-products":return e.jsx(dt,{});case"product-detail":return e.jsx(ut,{});case"not-best-price":return e.jsxs("div",{className:"p-4 text-center min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Ee,{title:"محصولات با قیمت غیر رقابتی",onBack:()=>$("dashboard")}),e.jsx("p",{className:"text-gray-600 mt-8",children:"این صفحه هنوز در حال توسعه است. به زودی ویژگی‌های بیشتری اضافه خواهد شد!"}),e.jsx(ze,{size:48,className:"text-yellow-500 mx-auto mt-8"})]});default:return e.jsx(Oe,{})}},R=o.useCallback((k,L={})=>{const v=new Headers(L.headers||{});return i&&v.set("Authorization",`Bearer ${i}`),fetch(k,{...L,headers:v})},[i]),M=o.useMemo(()=>({navigate:$,selectedProduct:d,setSelectedProduct:x,basalamToken:i,setBasalamToken:r,authorizedFetch:R,setGlobalLoading:_}),[$,d,i,R]);return e.jsx(xe.Provider,{value:M,children:e.jsxs("div",{className:"font-['Inter'] antialiased bg-gray-50 text-gray-900 min-h-screen",children:[w(),e.jsx(it,{isLoading:S})]})})},Oe=()=>{const{navigate:i,setBasalamToken:r}=o.useContext(xe);return e.jsx("div",{className:"p-4 max-w-md mx-auto h-screen flex flex-col justify-center",children:e.jsxs("div",{className:"bg-emerald-100 p-6 rounded-2xl shadow-lg flex flex-col items-center text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-emerald-800 mb-6",children:"به پنل Basalam خوش آمدید!"}),e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsxs("button",{onClick:()=>i("my-products"),className:"w-full flex items-center justify-center p-4 bg-emerald-600 text-white rounded-xl shadow-md hover:bg-emerald-700 transition duration-300 ease-in-out transform hover:scale-105",children:[e.jsx(Ye,{className:"mr-3"}),e.jsx("span",{className:"text-lg font-semibold",children:"همه محصولات من"})]}),e.jsxs("button",{onClick:()=>i("not-best-price"),className:"w-full flex items-center justify-center p-4 bg-yellow-500 text-white rounded-xl shadow-md hover:bg-yellow-600 transition duration-300 ease-in-out transform hover:scale-105",children:[e.jsx(ze,{className:"mr-3"}),e.jsx("span",{className:"text-lg font-semibold",children:"محصولات با قیمت غیر رقابتی"})]}),e.jsx("button",{onClick:()=>{r(""),i("login")},className:"w-full flex items-center justify-center p-3 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 transition duration-300 ease-in-out",children:"خروج"})]})]})})},xt=()=>{const{setBasalamToken:i,navigate:r,setGlobalLoading:m}=o.useContext(xe),[u,d]=o.useState(""),[x,S]=o.useState(""),[_,$]=o.useState(!1),[w,R]=o.useState(!1),[M,k]=o.useState(null),L=async v=>{v.preventDefault(),k(null),R(!0),m(!0);try{const C=await fetch("https://n8nstudent.dotavvab.com/webhook/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:x})});let h=null;try{h=await C.json()}catch{}if((h&&typeof h.status=="number"?h.status:C.ok?200:C.status||500)!==200){const q=h&&(h.message||h.error)||"ورود ناموفق بود";throw new Error(q)}const E=h==null?void 0:h.token;if(!E)throw new Error("توکن دریافتی معتبر نیست");i(E),r("dashboard")}catch(C){k((C==null?void 0:C.message)||"خطای ناشناخته رخ داد")}finally{R(!1),m(!1)}};return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-lg p-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-center text-emerald-700 mb-6",children:"ورود"}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"نام کاربری"}),e.jsx("input",{type:"text",className:"w-full border border-gray-300 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500",value:u,onChange:v=>d(v.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"کلمه عبور"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:_?"text":"password",className:"w-full border border-gray-300 rounded-xl px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-500",value:x,onChange:v=>S(v.target.value),required:!0}),e.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-500",onClick:()=>$(v=>!v),"aria-label":"toggle password",children:_?e.jsx(tt,{size:18}):e.jsx(ye,{size:18})})]})]}),M&&e.jsx("div",{className:"text-red-600 text-sm",children:M}),e.jsx("button",{type:"submit",disabled:w,className:"w-full py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition disabled:opacity-60",children:w?"در حال ورود...":"ورود"})]})]})})},Ge=document.getElementById("root");if(!Ge)throw new Error("Root container not found");const ht=Fe(Ge);ht.render(e.jsx(mt,{}));
